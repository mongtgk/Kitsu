# Фоновые задачи

Очередь задач реализована в `app/background/runner.py` и используется как in‑process worker без отдельного брокера.

## Диспетчер
- `default_job_runner` — singleton с `asyncio.Queue`.
- Статусы: `queued`, `running`, `succeeded`, `failed`. Хранятся в памяти; при рестарте очищаются.
- Дедупликация: задача с тем же ключом не ставится, пока предыдущая не завершилась (ключ хранится в `_statuses`).
- Поведение: до 3 попыток, линейный backoff (`backoff_seconds * attempts`), rollback/ошибки не подавляются.

## Активные задачи
- **Добавление в избранное** (`favorite:add:<user_id>:<anime_id>`) — создаёт запись `Favorite` после проверки существования аниме; используется в `POST /favorites`.
- **Удаление из избранного** (`favorite:remove:<user_id>:<anime_id>`) — удаляет запись в `DELETE /favorites/{anime_id}`.
- **Обновление прогресса** (`watch-progress:<user_id>:<anime_id>:...`) — создаёт или обновляет `WatchProgress` c валидацией эпизода, позиции и процента; вызывается в `POST /watch/progress`.

## Ограничения
- Очередь зависит от процесса Uvicorn: при остановке задания теряются.
- Нет расписания или повторителей, только задачи, инициированные HTTP‑запросами.
