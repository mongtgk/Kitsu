# Контракт границы API (`/api/*`)

## Назначение
- Префикс `/api` объединяет два слоя:
  - **internal** — бизнес-эндпоинты и БД (дублируют корневые маршруты `/favorites`, `/watch`, `/users`, `/health` под префиксом `/api`).
  - **proxy** — тонкий слой над внешними источниками (HiAnime, AniList и др.) для чтения данных без побочных эффектов.
- Префикс обязателен для интеграций parser/player/admin. Вся новая логика должна ссылаться на этот контракт.

## Разделение обязанностей
| Область | Что делает | Что запрещено |
| --- | --- | --- |
| internal | Бизнес-правила, валидация, работа с БД, RBAC, выдача и прием Bearer-токенов | Доступ к внешним источникам минуя явные прокси |
| proxy (`/api/schedule`, `/api/search`, `/api/anime/*`, `/api/episode/*`, `/api/import/anilist`) | HTTP fetch внешних страниц/JSON, минимальная нормализация/маппинг полей, возврат 502 при недоступности upstream | Любая бизнес-логика, RBAC, запись в БД, управление сессиями или токенами |

## Правила для proxy-слоя
- Только чтение: никаких write-операций, мутаций состояния, изменения ролей или токенов.
- Минимальная адаптация: парсинг HTML/JSON, приведение типов, защита от падения при невалидных данных.
- Ошибки: сети/код >=500 у источника транслируются как 502/500 без попыток «починить» данные.

## Временный характер
- Proxy — временный слой до появления собственного parser/player. По мере появления внутренних источников данные должны переноситься в internal-эндпоинты, а прокси — упрощаться или удаляться.
- Любое новое взаимодействие с внешними источниками оформляется как отдельный proxy-эндпоинт с теми же запретами и с явной ссылкой на план миграции в internal.
