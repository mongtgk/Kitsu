# Контракт фронтенд ↔ бэкенд

## Маршруты, которые вызывает фронтенд
| Маршрут | Метод | Назначение | Требования | Ошибки/заметки |
| --- | --- | --- | --- | --- |
| /auth/login | POST | Вход по email+password | Без токена | 401 при неверных данных |
| /auth/register | POST | Регистрация + выдача токенов | Без токена | 400 если email занят |
| /auth/refresh | POST | Ротация пары токенов | Тело `refresh_token` | 401 неизвестный/просроченный refresh, 403 отозванный |
| /auth/logout | POST | Отзыв refresh | Тело `refresh_token` | 204 всегда; использовать для явного выхода |
| /users/me | GET | Профиль текущего пользователя | `Authorization: Bearer` обязателен | 401 при недействительном токене |
| /favorites | GET | Список избранного | Bearer | 401 без токена |
| /favorites | POST | Добавление избранного | Bearer + право `write:content` | 401 без токена, 403 без права, 409 при дубликате |
| /favorites/{anime_id} | DELETE | Удаление избранного | Bearer + право `write:content` | 401/403 аналогично, 204 даже если записи не было |
| /search/anime | GET | Поиск в каталоге | Публично | 400 при отсутствии/коротком `q` |
| /api/schedule | GET | Расписание (proxy) | Публично | 502/500 при недоступном источнике |
| /api/episode/servers | GET | Список серверов (proxy) | Публично | 502/500 при ошибках парсинга/источника |
| /api/episode/sources | GET | Ссылки на стрим (proxy) | Публично | 502/500 при ошибках парсинга/источника |
| /api/import/anilist | POST | Маппинг списка AniList (proxy) | Публично | 400 при некорректном теле, 502/500 при сбое запроса |

## Интерпретация кодов
- **401** — нет или истёкший Bearer, неподписанный/битый токен, неверный refresh. Требует очистки локальной сессии или повторного логина после попытки refresh.
- **403** — недостаточно прав (RBAC) либо refresh отозван. Фронтенд обязан прекратить повторные попытки и показать отказ в доступе.
- **500/502** — внутренняя ошибка или недоступен upstream (proxy). Запрос можно повторить позже, но UI должен показывать деградацию вместо бесконечных ретраев.

## Правила для фронтенда
- Использовать `Authorization: Bearer <access_token>` для всех защищённых вызовов; не отправлять запросы, требующие прав, без токена.
- При 401: выполнить один поток refresh, затем очистить сессию при неуспехе. При 403: немедленно очистить сессию/показать отказ, не повторять.
- Ожидать структуру ошибки `{code, message, details?}` и не подменять её произвольными сообщениями.
- Proxy-ответы не содержат бизнес-логики и не требуют RBAC; фронт не должен пытаться записывать данные через `/api/*`.

## Чего фронтенд не делает
- Не пытается самостоятельно вычислять роли/права или скрывать ошибки сервера успехом.
- Не реализует редиректы/guard-логику без подтверждённого серверного контракта.
- Не кэширует токены/права дольше срока действия access token; при сомнении повторно читает `/users/me` после успешного refresh.

## Поведение при отказах бэкенда
- HTTP-клиент (axios) настроен на timeout 10 секунд; автоматических ретраев нет. Повторы допускаются только вручную или явно запрограммированным одиночным повтором.
- В случае таймаута или 5xx показывать сообщение об ошибке и позволять ручной повтор, избегая бесконечных циклов перезапроса.
- Для proxy-эндпоинтов принимать возможность частичной/пустой выдачи (пустые списки, обнулённые поля) без падения UI.
