# P2.4.D Post-fix Contract Audit

## Auth Flow — OK
- Single refresh attempt on 401 with replay and logout on 401/403/refresh failure handled in interceptor and auth error handler (frontend/lib/api.ts:25-98, frontend/lib/auth-errors.ts:86-133).
- `/users/me` is only fetched with explicit/attached `Authorization` header during auth flows (frontend/components/login-popover-button.tsx:34-49, frontend/components/navbar.tsx:50-87).
- Token responses keep `token_type="bearer"` via schema default (backend/app/schemas/auth.py:14-18).

## Frontend ↔ Backend — OK
- Frontend defers access decisions to backend; role/permission hooks are used for UX-only disabling (frontend/auth/rbac.ts:13-55, frontend/app/anime/watch/layout.tsx:177-188).
- Axios client handles 401/403/5xx via centralized normalization without client-side overrides (frontend/lib/api.ts:36-98, frontend/lib/auth-errors.ts:12-134).
- `/api/*` calls align to documented routes (e.g., schedule/episode/import) using shared client with 10s timeout and no extra retries (frontend/query/get-anime-schedule.ts:6-16, frontend/query/get-episode-servers.ts:6-29, frontend/query/get-episode-data.ts:6-37, frontend/app/profile/[username]/components/anilist-import.tsx:59-101).

## Proxy Layer — OK
- `/api/search/suggestion` now maps upstream 4xx directly and 5xx/network errors to 502 with neutral messaging (backend/app/api/proxy/search.py:1-63).
- `/api/anime/{anime_id}` and `/api/anime/{anime_id}/episodes` now wrap upstream 4xx/5xx/network errors into HTTPExceptions (4xx passthrough, 5xx/network → 502) without altering success payloads (backend/app/api/proxy/anime.py:1-66, backend/app/api/proxy/episodes.py:1-174).

## Background Jobs — OK
- HTTP responses are decoupled from job execution; handlers enqueue and return immediately (backend/app/use_cases/favorites/add_favorite.py:51-71, remove_favorite.py:20-30, watch/update_progress.py:102-152).
- Deterministic job keys ensure idempotency/deduplication, with linear backoff and max attempts honored by runner (backend/app/background/runner.py:18-98).
- Job handlers open independent DB sessions and avoid request context usage (backend/app/use_cases/favorites/add_favorite.py:41-49, remove_favorite.py:10-18, watch/update_progress.py:77-100).

## RBAC — OK
- RBAC enforcement stays server-side; frontend uses role/permission only for UX (disabling import/favorite actions) without client-side allow/deny logic (frontend/app/profile/[username]/components/anilist-import.tsx:125-200, frontend/app/anime/watch/layout.tsx:176-188).
- Backend role mapping and token verification remain centralized (backend/app/auth/rbac.py, backend/app/auth/enforcement_matrix.py referenced in contracts).

### Verdict
**P2.4 CLOSED** — All proxy endpoints align with error-handling contract; prior violations resolved.
