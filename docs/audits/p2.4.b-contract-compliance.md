P2.4.B — CONTRACT COMPLIANCE AUDIT

1. BACKEND

❌ Нарушения:
- [ ] Не выявлено

⚠️ Риски:
- [ ] Нет

✅ OK:
- [x] Аутентификация соответствует контракту: выдаётся `token_type="bearer"`, refresh хранится в хеше и ротируется при `/auth/refresh`, logout идемпотентен (docs/contracts/auth.md; backend/app/use_cases/auth/register_user.py:26-36, backend/app/use_cases/auth/refresh_session.py:12-25, backend/app/use_cases/auth/logout_user.py:8-19).

--------------------------------

2. FRONTEND

❌ Нарушения:
- [x] При 401 отсутствует обязательная одиночная попытка `/auth/refresh`: интерсептор сразу чистит сессию и не различает 401/403 (docs/contracts/auth.md, сценарии истёкшего/отозванного токена; frontend/lib/api.ts:16-29, frontend/lib/auth-errors.ts:117-128).
- [x] Защищённый `/users/me` вызывается без заголовка `Authorization` до сохранения токенов после login/register, что запрещено контрактом (docs/contracts/frontend-backend.md, правила 26-27; frontend/components/login-popover-button.tsx:48-56,112-118).

⚠️ Риски:
- [ ] Нет

✅ OK:
- [x] При наличии токена все запросы получают `Authorization: Bearer <token>` через axios-интерсептор (docs/contracts/frontend-backend.md; frontend/lib/api.ts:16-23).

--------------------------------

3. PROXY / INTEGRATION LAYER

❌ Нарушения:
- [x] При сбоях внешнего источника в импорте AniList ошибки проглатываются и возвращается 200 с пустым списком вместо 502/500 (docs/contracts/api-boundary.md, раздел «Ошибки»; backend/app/api/proxy/import_anilist.py:33-59).

⚠️ Риски:
- [ ] HTTPStatusError из proxy-эндпоинтов (schedule/episodes) напрямую превращается в 500 без явного маппинга на 502 для недоступного upstream (docs/contracts/api-boundary.md; backend/app/api/proxy/schedule.py:18-72, backend/app/api/proxy/episodes.py:61-138).

✅ OK:
- [x] Proxy-слой ограничен чтением и парсингом внешних данных, без обращения к БД или RBAC (docs/contracts/api-boundary.md; backend/app/api/proxy/*.py).

--------------------------------

4. BACKGROUND JOBS

❌ Нарушения:
- [ ] Не выявлено

⚠️ Риски:
- [ ] Нет

✅ OK:
- [x] Очередь `default_job_runner` обеспечивает линейный бэкофф до 3 попыток и идемпотентные ключи для задач избранного, HTTP-ответ не зависит от выполнения job (docs/contracts/background-jobs.md; backend/app/background/runner.py:18-98, backend/app/use_cases/favorites/add_favorite.py:62-71, backend/app/use_cases/favorites/remove_favorite.py:20-30).

--------------------------------

5. AUTH / RBAC

❌ Нарушения:
- [ ] Не выявлено

⚠️ Риски:
- [ ] Маршруты-заглушки `/users` без аутентификации/матрицы не описаны в контракте и могут требовать уточнения перед использованием (docs/contracts/rbac.md; backend/app/routers/users.py:58-78).

✅ OK:
- [x] Роли и разрешения соответствуют контракту, матрица ENFORCEMENT_MATRIX совпадает с docs/RBAC_CONTRACTS.md и применяется через `get_current_role` + `require_enforced_permission` (docs/contracts/rbac.md; backend/app/auth/rbac.py:10-38, backend/app/auth/enforcement_matrix.py:9-23, docs/RBAC_CONTRACTS.md:1-11).

--------------------------------

ИТОГ:
- Общее количество нарушений: 3
- Критические (блокируют следующий этап): 3
- Можно ли переходить к фиксам: NO
