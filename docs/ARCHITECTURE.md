# Архитектура

## Компоненты
- **Frontend** — Next.js 15 (app router) и React 18. Общается с FastAPI через `NEXT_PUBLIC_API_BASE_URL` по REST/JSON.
- **Backend** — FastAPI с async SQLAlchemy 2 и Alembic. Использует PostgreSQL, отдает статические аватары по `/media/avatars`, выполняет миграции и проверку БД на старте. RBAC применяется через зависимость `require_enforced_permission`. Прокси‑роуты `/api/*` ходят к внешнему HiAnime (aniwatch) для поиска, расписаний, эпизодов и источников, а также маппинга импортируемых списков AniList.
- **Хранилище** — PostgreSQL (обязательно). Файлы аватаров лежат в `backend/uploads/avatars` и раздаются самим FastAPI.
- **Фоновые задачи** — встроенный `default_job_runner` (in‑process очередь без персистентности) обслуживает записи избранного и прогресса просмотра.

## Слои API
UI → `/api` (proxy/internal) → background jobs → DB.

- **Internal** — бизнес‑операции (`/favorites`, `/watch`, `/users/me`, `/health`) без внешних HTTP вызовов.
- **Proxy** — тонкий слой, пробрасывающий данные из HiAnime и AniList без бизнес‑логики и без parser/player; используется только для текущих легаси‑контрактов `/api/*` и остаётся временным.
- Parser/Player будут подключаться позже поверх прозрачных границ; фронтенд и существующие контракты не меняются.

## Потоки данных
1. Пользователь получает токены через `/auth/register`, `/auth/login` или `/auth/refresh`. UI сохраняет их в auth‑сторе и отправляет в `Authorization: Bearer` для защищённых запросов.
2. Каталог, релизы, эпизоды, поиск и избранное читаются с FastAPI. При недоступном бэкенде UI рендерит пустые состояния или тосты об ошибке.
3. Источники воспроизведения и поиск по HiAnime идут через FastAPI `/api/*` и не требуют клиентских Node API. Для проигрывателя требуется `NEXT_PUBLIC_PROXY_URL` (endpoint `/m3u8-proxy` вне репозитория) для корректного HLS‑проксирования.
4. `/favorites` и `/watch/progress` возвращают быстрый ответ и ставят запись/обновление в очередь `default_job_runner`; обработчик создаёт отдельную БД‑сессию и коммитит изменения.
5. `/users/me` при загрузке аватара сохраняет файл на файловую систему контейнера; при успешном коммите старый файл удаляется, а новая статика доступна по `/media/avatars/<имя>`.
6. `/health` проверяет доступность БД; приложение не стартует, если миграции не применены или база недоступна.

## Границы и зависимости
- Нет внешних очередей или cron: фоновая очередь живёт в процессе Uvicorn и очищается при рестарте.
- Все RBAC решения принимаются на бэкенде; UI дублирует проверку для скрытия кнопок, но не заменяет серверные проверки.
- Для корректной работы фронтенда требуются одновременно доступный FastAPI и m3u8‑прокси (`NEXT_PUBLIC_PROXY_URL`).
